{{!< default}}

{{!-- Everything inside the #post tags pulls data from the post --}}
{{#post}}
<div class="bg-yellow blog-header {% if page.image %}has-image{% endif %}">
  <div class="d-flex flex-wrap flex-lg-nowrap skinny container">
    <div class="mt-md-4 w-100 mb-md-2 text-center">
      <p class="tiny-caption">
        {{#primary_author}}
          <a href="{{url}}">{{name}}</a>
        {{/primary_author}}
        <time class="post-full-meta-date" datetime="{{date format="YYYY-MM-DD"}}">{{date format="D MMMM YYYY"}}</time>
      </p>
      <h2>{{title}}</h2>
      {{#if feature_image}}
      <figure class="post-full-image">
          {{!-- This is a responsive image, it loads different sizes depending on device
          https://medium.freecodecamp.org/a-guide-to-responsive-images-with-ready-to-use-templates-c400bd65c433 --}}
          <img
              srcset="{{img_url feature_image size="s"}} 300w,
                      {{img_url feature_image size="m"}} 600w,
                      {{img_url feature_image size="l"}} 1000w,
                      {{img_url feature_image size="xl"}} 2000w"
              sizes="(max-width: 800px) 400px,
                      (max-width: 1170px) 700px,
                      1400px"
              src="{{img_url feature_image size="xl"}}"
              alt="{{title}}"
          />
      </figure>
      {{/if}}
    </div>
  </div>
</div>

{{#if feature_image}}
<div style="background-image: url({img_url feature_image size="xl"}})" class="blog-image d-md-none"></div>
{{/if}}

<div class="skinny container d-md-none py-2">
  <figcaption class="underline tiny-caption text-left">{{ page.caption }}</figcaption> 
</div>

<div class="skinny container top-section section blog-post">
  <div class="row">
    <div class="col-md-8 offset-md-2">
      {{ content }}

      <h2>Tags</h2>
      {{#primary_tag}}
          <span class="date-divider">/</span> <a href="{{url}}">{{name}}</a>
      {{/primary_tag}}
    </div>
  </div>
</div>

{{/post}}

{{!-- The #contentFor helper here will send everything inside it up to the matching #block helper found in default.hbs --}}
{{#contentFor "scripts"}}
<script>

// NOTE: Scroll performance is poor in Safari
// - this appears to be due to the events firing much more slowly in Safari.
//   Dropping the scroll event and using only a raf loop results in smoother
//   scrolling but continuous processing even when not scrolling
$(document).ready(function () {
    // Start fitVids
    var $postContent = $(".post-full-content");
    $postContent.fitVids();
    // End fitVids

    var progressBar = document.querySelector('#reading-progress');
    var header = document.querySelector('.floating-header');
    var title = document.querySelector('.post-full-title');

    var lastScrollY = window.scrollY;
    var lastWindowHeight = window.innerHeight;
    var lastDocumentHeight = $(document).height();
    var ticking = false;

    function onScroll() {
        lastScrollY = window.scrollY;
        requestTick();
    }

    function onResize() {
        lastWindowHeight = window.innerHeight;
        lastDocumentHeight = $(document).height();
        requestTick();
    }

    function requestTick() {
        if (!ticking) {
            requestAnimationFrame(update);
        }
        ticking = true;
    }

    function update() {
        var trigger = title.getBoundingClientRect().top + window.scrollY;
        var triggerOffset = title.offsetHeight + 35;
        var progressMax = lastDocumentHeight - lastWindowHeight;

        // show/hide floating header
        if (lastScrollY >= trigger + triggerOffset) {
            header.classList.add('floating-active');
        } else {
            header.classList.remove('floating-active');
        }

        progressBar.setAttribute('max', progressMax);
        progressBar.setAttribute('value', lastScrollY);

        ticking = false;
    }

    window.addEventListener('scroll', onScroll, {passive: true});
    window.addEventListener('resize', onResize, false);

    update();

});
</script>
{{/contentFor}}
